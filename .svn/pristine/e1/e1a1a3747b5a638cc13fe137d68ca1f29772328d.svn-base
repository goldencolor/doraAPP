<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>新用户缴费</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <!--AUI根据使用情况引入-->
    <link rel="stylesheet" type="text/css" href="../../css/2_0/aui_2_0.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/2_0/rem.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/2_0/util.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/fonts/duola_iconfont2.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/swiper.min.css"/>
    <style>
        html, body{
            background: #FFFFFF;
            padding: 0rem;
            margin: 0rem;
        }
        /**{margin:0; padding:0; font-size: 0;}*/
        .shadow-l{
            background-color: #ECECEC;
            height: 0.5rem;
        }
        .shadow-s{
            background-color: #ECECEC;
            height: 1px;
        }
        #app{
            width: 100%;
            height: 100%;
            position: relative;
            background: #F8F8F8;
        }
        .header{
            width: 100%;
            position: relative;
            background: #F8F8F8;
        }
        .iconLeftBtn{
            width: 2.5rem;
            height: 2.5rem;
            position: absolute;
            bottom: 0rem;
            left: 0rem;
            text-align: center;
            line-height: 2.5rem;
            z-index: 2;
        }
        .iconRightBtn{
            width: 2.5rem;
            height: 2.5rem;
            position: absolute;
            bottom: 0rem;
            right: 0rem;
            text-align: center;
            line-height: 2.5rem;
            z-index: 2;
        }
        .headerTitle{
            font-family: SourceHanSansCN-Regular;
            font-size: 15px;
            color: #000000;
            width: 100%;
            height: 2.5rem;
            line-height: 2.5rem;
            text-align: center;
            z-index: 1;
        }
        .daifu{
            font-family: SourceHanSansCN-Regular;
            font-size: 14px;
            color: #666666;
            margin-top: 3.5rem;
            width: 100%;
            text-align: center;
        }
        .payBtn{
            width: 100%;
            height: 3rem;
            background-color: #1ED3B8;
            position: absolute;
            bottom: 0rem;
            left: 0rem;
        }
        .card-header0{
            width: 100%;
            height: 12.4rem;
            background-image: linear-gradient(45deg, #5DE2A5 0%, #1ADC9C 100%);
            box-shadow: 0px 2px 7px 0px rgba(36,99,67,0.15);
            -webkit-box-shadow: 0px 2px 7px 0px rgba(36,99,67,0.15);
            border-radius: 4px 4px 0px 0px;
         }
        .card-header1{
            width: 100%;
            height: 12.4rem;
            background-image: linear-gradient(-135deg, #FF5065 0%, #FE5858 100%);
            /*-webkit-background-image: linear-gradient(-135deg, #FF5065 0%, #FE5858 100%);*/
            box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            -webkit-box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            border-radius: 4px 4px 0px 0px;
        }
        .card-header2{
            width: 100%;
            height: 12.4rem;
            background-image: linear-gradient(-135deg, #fa6b43 0%, #ff7d63 100%);
            /*-webkit-background-image: linear-gradient(-135deg, #FF5065 0%, #FE5858 100%);*/
            box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            -webkit-box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            border-radius: 4px 4px 0px 0px;
        }
        .card-header3{
            width: 100%;
            height: 12.4rem;
            background-image: linear-gradient(-135deg, #50bbff 0%, #55c6f2 100%);
            /*-webkit-background-image: linear-gradient(-135deg, #FF5065 0%, #FE5858 100%);*/
            box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            -webkit-box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            border-radius: 4px 4px 0px 0px;
        }
        .card-header4{
            width: 100%;
            height: 12.4rem;
            background-image: linear-gradient(-135deg, #8a73ff 0%, #9461f2 100%);
            /*-webkit-background-image: linear-gradient(-135deg, #FF5065 0%, #FE5858 100%);*/
            box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            -webkit-box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            border-radius: 4px 4px 0px 0px;
        }
        .card-footer{
            width: 100%;
            height: 6.4rem;
            background: #FFFFFF;
            box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            -webkit-box-shadow: 0px 2px 7px 0px rgba(210,49,69,0.15);
            border-radius: 0px 0px 4px 4px;
        }
        .vip-title{
            font-family: SourceHanSansCN-Bold;
            font-size: 1rem;
            color: #FFFFFF;
            margin-left: 1rem;
            padding-top: 1.5rem;
        }
        .vip-money{
            font-family: SourceHanSansCN-Bold;
            font-size: 0.9rem;
            color: #FFFFFF;
            margin-left: 1rem;
            margin-top: 1rem;
        }
        .vip-yajin{
            font-family: SourceHanSansCN-Regular;
            font-size: 0.7rem;
            color: #FFFFFF;
            margin-left: 1rem;
            margin-top: 0.5rem;
        }
        .vip-zm{
            font-family: SourceHanSansCN-Regular;
            font-size: 0.7rem;
            color: #FFFFFF;
            margin-left: 1rem;
            margin-top: 0.75rem;
        }
        .vip-jianshu-active{
            background: rgba(255,255,255,0.30);
            border-radius: 0.2rem;
            font-family: SourceHanSansCN-Regular;
            font-size: 0.7rem;
            color: #FFFFFF;
            text-align: center;
            height: 1.75rem;
            line-height: 1.75rem;
        }
        .vip-jianshu{

            font-family: SourceHanSansCN-Regular;
            font-size: 0.7rem;
            color: #FFFFFF;
            text-align: center;
            height: 1.75rem;
            line-height: 1.75rem;
        }
        .vip-text{
            font-family: SourceHanSansCN-Regular;
            font-size: 0.5rem;
            color: #666666;
            text-align: center;
        }
        .spot{
            width: 0.2rem;
            height: 0.2rem;
            border-radius: 50%;
            margin-bottom:0.11rem;
            background-color: #D5D5D5;
            padding-right: 0.04rem;
        }
        .red-dot{
            width: 0.6rem;
            height: 0.6rem;
            background-color: #FF0000;
            border-radius: 50%;
            border: solid #FFFFFF 1px;
            position: absolute;
            bottom: 1.5rem;
            right: 0.5rem;
        }
    </style>
</head>
<body>

<div id="app" v-cloak v-if="showApp">
    <div class="header" id="header">
        <i class="duola-iconfont icon-left iconLeftBtn" onclick="closeIcon()"></i>
        <i class="duola-iconfont icon-service iconRightBtn hide" @click="openMeChats()"></i>
        <div class="red-dot hide" v-if="meiqiaCount != 0"></div>
        <span class="headerTitle">会员开通</span>
    </div>
    <div class="shadow-s"></div>
    <!-- Swiper -->
    <div class="swiper-container" style="margin-top: 3.25rem">
        <div class="swiper-wrapper" style="height: 18.75rem; width: 13.75rem!important;">
            <div class="swiper-slide" style="width: 13.75rem;" v-for="(item, i) in 5" :id="'swiperSlide'+i">
                <div v-bind:class="{ 'card-header0': i == 0, 'card-header1': i == 1, 'card-header2': i == 2, 'card-header3': i == 3, 'card-header4': i == 4,}" style="position: relative">
                    <div class="vip-title">
                        {{times[i].title}}
                    </div>
                    <div style="background-color:  #FFFFFF;margin-left: 1rem;margin-top: 1.25rem; height: 2px;width: 2.4rem">
                    </div>
                    <div class="vip-money">
                        <!--{{times[i].amount}} -->
                        {{times[i].content}}
                    </div>

                    <div class="aui-row" style="margin-left: 1rem;margin-right: 1rem;margin-top: 2rem;">
                        <div v-bind:class="{'aui-col-xs-4':true, 'vip-jianshu-active':times[i].bag == 1, 'vip-jianshu':times[i].bag != 1 }" @click="changeClothesNum(i, 3)">
                            3件衣服
                        </div>
                        <div v-bind:class="{'aui-col-xs-4':true, 'vip-jianshu-active':times[i].bag == 2, 'vip-jianshu':times[i].bag != 2 }" @click="changeClothesNum(i, 6)" v-if="i != 0">
                            6件衣服
                        </div>
                        <div v-bind:class="{'aui-col-xs-4':true, 'vip-jianshu-active':times[i].bag == 3, 'vip-jianshu':times[i].bag != 3 }" @click="changeClothesNum(i, 9)" v-if="i != 0">
                            9件衣服
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="aui-row" style="margin-left: 1rem;margin-right: 1rem; padding-top: 0.5rem">
                        <div class="aui-col-xs-3 vip-text">
                            <span class="spot"></span>24小时发货
                        </div>
                        <div class="aui-col-xs-3 vip-text">
                            <span class="spot"></span>无限穿衣
                        </div>
                        <div class="aui-col-xs-3 vip-text">
                            <span class="spot"></span>服装免洗
                        </div>
                        <div class="aui-col-xs-3 vip-text">
                            <span class="spot"></span>往返包邮
                        </div>

                    </div>

                    <div style="margin-left: 1rem;margin-top: 1.5rem">
                        <span
                                style="font-family: SourceHanSansCN-Regular;font-size: 0.7rem;color: #333333;line-height: 1rem;">
                            结算：
                        </span>
                        <span
                                style="font-family: SourceHanSansCN-Bold;font-size: 1rem;color: #333333;">
                            {{(inviteCode != '') && (i != 0)? times[i].payMoney - discount:times[i].payMoney}}元
                        </span>
                        <span
                                style="font-family: SourceHanSansCN-Regular;font-size: 12px;color: #999999;margin-left: 0.5rem"
                                v-if="inviteCode != '' && i != 0">
                            原价：{{times[i].payMoney}}元
                        </span>
                        <span
                                style="font-family: SourceHanSansCN-Regular;font-size: 12px;color: #999999;margin-left: 1rem"
                                v-if="i == 0 && inviteCode != ''">
                            不能同时享受其他优惠
                        </span>
                    </div>
                    <div style="color: #000000;font-size: 0.55rem; margin-left: 1rem;margin-right: 1rem; height: 2rem; line-height: 2rem">
                        {{i == 0||i == 1?'首次选衣下单需付押金（芝麻分≥700免押）':''}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="daifu hide">找他人代付</div>

    <div class="payBtn aui-row" style="background: #FFFFFF;">
        <div class="aui-col-xs-6" style="height: 100%;border-right: 0.5px solid #E1E1E1; line-height: 3rem;text-align: center" @click="userPay('alipay')">
            <span class="duola-iconfont icon-Alipay" style="color: #1B9DFF; font-size: 1rem"></span>
            <span style="font-family: SourceHanSansCN-Light;font-size: 1rem;color: #333333;">支付宝支付</span>
        </div>
        <div class="aui-col-xs-6" style="height: 100%;border-left: 0.5px solid #E1E1E1; line-height: 3rem;text-align: center" @click="userPay('wx')">
            <span class="duola-iconfont icon-wechat-money" style="color: #02D10F; font-size: 1rem"></span>
            <span style="font-family: SourceHanSansCN-Light;font-size: 1rem;color: #333333;">微信支付</span>
        </div>
    </div>
</div>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/url.js"></script>
<script type="text/javascript" src="../../script/uz.js"></script>
<script type="text/javascript" src="../../script/umeng_sdk.js"></script>
<script type="text/javascript" src="../../script/meiqia_sdk.js"></script>
<script type="text/javascript" src="../../script/swiper.min.js"></script>
<script type="text/javascript" src="../../script/vue/vue.min.js"></script>
<script type="text/javascript" src="../../script/pingpp.js"></script>
<script type="text/javascript">
    var vm;
    var headerEl;
    apiready = function () {
        sendEventUmeng(CONSTANT.UMENGEVENT.PAGE_VIP);
        vm = new Vue({
            el: '#app',
            data: {
                showApp: true,
                types: [],
                charges: [],
                inviteCode: '',
                selectedIndex:0,
                vip_date:1,
                vip_bag:1,
                times:[
                    {
                        title: '10天会员体验',
                        content: '有效期10天',
                        amount: '',
                        payMoney: '',
                        bag:1
                    },
                    {
                        title: '月费会员开通',
                        content: '有效期1个月',
                        amount: '',
                        payMoney: '',
                        bag:1
                    },
                    {
                        title: '季费会员开通',
                        content: '有效期3个月',
                        amount: '',
                        payMoney: '',
                        bag:1
                    },
                    {
                        title: '半年费会员开通',
                        content: '有效期6个月',
                        amount: '',
                        payMoney: '',
                        bag:1
                    },
                    {
                        title: '年费会员开通',
                        content: '有效期12个月',
                        amount: '',
                        payMoney: '',
                        bag:1
                    }
                ],
                shouldPayMoney: 0,
                meiqiaCount: 0

            },
            mounted: function () {
//                挂载成功  逻辑代码执行入口
                headerEl = $api.byId('header');
                $api.fixStatusBar(headerEl);
                var self = this;
                self.init();
            },
            closeWin: function () {
              api.closeWin();
            },
            beforeUpdate: function () {
//                数据发生变化时，更新界面前的回调
                var self = this;
            },
            updated: function () {
//                数据发生变化时，更新界面结束的回调  不要做数据修改操作  否则会发生死循环
                var self = this;
            },
            methods: {
                init: function () {
//                    初始化方法  只执行一次
                    var self = this;
//                    初始化监听
                    self.setEventListener();
                    self.initSwpier();
                    self.getPayData();
                    mqInit(function (count) {
                        //客服
                        self.meiqiaCount = count;
                    });
                },
                openMeChats: function () {
                    var self = this;
                    sendEventUmeng(CONSTANT.UMENGEVENT.ONLINE_SERVICE, {
                        from: '开通会员'
                    });
                    if(CONSTANT.SWITCH.MEIQIA){
                        mqShow();
                    }else{
                        mqHttpChat();
                    }
                    api.sendEvent({
                        name: 'clearMqCountIndex'
                    });
                    self.meiqiaCount = 0;
                },
                userPay: function (type) {
                    var self = this;
                    var payMoney = self.shouldPayMoney;
                    if (self.inviteCode != ''){
                    	if (self.selectedIndex != 0)
                        	payMoney -= self.discount;
                    }
                    api.showProgress({
                        style: 'default',
                        animationType: 'fade',
                        title: '正在支付···',
                        text: '请稍候'
                    });
                    var body = {
                        "bags": self.vip_bag,
                        channel: type,
                        amountFront: payMoney,
                        coupons: [],
                        duration: self.times[self.selectedIndex].duration,
                        durationUnit: self.times[self.selectedIndex].durationUnit,
                        leaseLimit: self.vip_bag*3
                    };
                    var url = serviceUser + 'service/pay/start/openMember';
                    var headers = _getAjaxHeaders(true, false);
                    var data = _getAjaxData(body);
                    var extra = null;
                    _ajaxData(url, 'post', headers, data, function (ret, extra) {
                        _loadingHide();
                        if (ret.statusCode == '200') {
                            ping(ret.charge,'userPayNew');
                        } else if (ret.statusCode == '10104') {
                            goLogin('',"../win_regin.html");
                        } else {
                            toastMsg(ret.msg);
                        }
                    }, function (err, extra) {
                        _loadingHide();
                        toastMsg(err.msg);
                    }, 0, extra);

                },
                changeClothesNum: function (i, clothesNum) {
                    var self = this;
//                    var activeDom = $api.dom($api.byId('swiperSlide'+i),'.vip-jianshu-active');
//                    $api.removeCls(activeDom, 'vip-jianshu-active');
//                    $api.addCls(activeDom, 'vip-jianshu');
//
//                    $api.removeCls(event.currentTarget,'vip-jianshu');
//                    $api.addCls(event.currentTarget,'vip-jianshu-active');
                    self.times[i].payMoney = self.times[i].amount *clothesNum/3;
                    self.shouldPayMoney = self.times[i].amount *clothesNum/3;
                    self.times[i].bag = clothesNum/3;
                    self.vip_bag = clothesNum/3;
                },
                getPayData: function () {
                    var self = this;
                    var url = serviceUser + 'service/pay/query/moreChannel';
                    var headers = _getAjaxHeaders(true, false);
                    var body = {"bags": 1};
                    if (this.promotion) {
                        body.promotion = this.promotion;
                    }
                    var data = _getAjaxData(body);
                    var extra = {promotion: this.promotion};
                    _ajaxData(url, 'post', headers, data, function (ret, extra) {
                        console.log("charges == "+JSON.stringify(ret))
                        if (ret.statusCode == '200') {
                            self.types = ret.types;
                            self.charges = ret.charges;
                            self.inviteCode = ret.inviteCode;
                            for(var i = 0, len = ret.charges.length; i<len; i++){
                                self.times[i].amount = ret.charges[i].amount;
                                self.times[i].payMoney = ret.charges[i].amount;
                                self.times[i].duration = ret.charges[i].duration;
                                self.times[i].durationUnit = ret.charges[i].durationUnit;                                
                            }
                            self.shouldPayMoney = ret.charges[0].amount;
                            self.discount = ret.discount;
                        } else if (ret.statusCode == '10104') {
                            goLogin('',"../win_regin.html");
                        } else {
                            toastMsg(ret.msg);
                        }
                    }, function (err, extra) {
                        toastMsg(err.msg);
                        loadingHide();
                    }, 0, extra);
                },
                initSwpier: function () {
                    var self = this;
                    var width = 13.25 * parseInt($api.cssVal($api.dom('html'),'font-size'));
                    var MySwiper = new Swiper('.swiper-container', {
                        slidesPerView: 'auto',
                        centeredSlides: true,
                        spaceBetween: 10,
//                        loop: true,
                        effect : 'coverflow',
                        centeredSlides: true,
                        coverflow: {
                            rotate: 30,
                            stretch: 10,
                            depth: 60,
                            modifier: 2,
                            slideShadows : true
                        },
                        onTransitionEnd: function(swiper){
                            console.log("activeIndex === "+swiper.activeIndex%5);
                            self.selectedIndex = swiper.activeIndex%5;
                            self.shouldPayMoney = self.times[swiper.activeIndex%5].payMoney;
                            self.vip_bag = self.times[swiper.activeIndex%5].bag;
                        }
                    });
                },
                setEventListener: function () {
//                    初始化时设置监听事件
                    var self = this;
                    api.addEventListener({
                        name:'pause'
                    }, function(ret, err){
                        self.pause();
                    });
                    api.addEventListener({
                        name:'resume'
                    }, function(ret, err){
                        self.resume();
                    });
                    api.addEventListener({
                        name:'scrolltobottom',
                        extra:{
                            threshold:0            //设置距离底部多少距离时触发，默认值为0，数字类型
                        }
                    }, function(ret, err){
                    });
                    api.addEventListener({
                        name:'offline'
                    }, function(ret, err){
                    });
                    api.addEventListener({
                        name:'online'
                    }, function(ret, err){
                    });
                    if(api.systemType == 'ios'){
                        api.addEventListener({
                            name:'viewdisappear'
                        },function(ret,err){
                            goBackIndex();
                        });
                    }else if(api.systemType == 'android'){
                        api.addEventListener({
                            name: 'keyback'
                        },function(ret,err){
                            goBackIndex();
                        });
                    }
                },
                start: function () {
//                    初始化后执行
                    var self = this;

                },
                pause: function () {
//                    页面进入后台时进行，但未关闭时进行相关操作时调用
                    var self = this;

                },
                resume: function () {
//                    页面在后台状态时，需要操作时调用
                    var self = this;

                },
                destroy: function(){
//                  销毁界面时调用
                }
            },
            computed: {

            }
        })
    }
    //    用于apicloud的execScript方法调用Vue中各个生命周期中的方法
    function start() {
        vm.start();
    }
    function resume() {
        vm.resume();
    }
    function pause() {
        vm.pause();
    }
    //支付完成后调用check_pay接口验证
    function check(channel,amount) {

        var url = serviceUser + 'service/check/payment';
        var headers = _getAjaxHeaders(true, false);
        var data = _getAjaxData();
        var extra = {channel:channel,amount:amount};
        _ajaxData(url, 'post', headers, data, checkSuccessCallback, checkErrorCallback, 0, extra);
    }
    function checkSuccessCallback(ret, extra) {
        if (ret.statusCode == '200') {
            //ios系统打开新页面触发了viewdisappear事件
            if(api.systemType == 'ios'){
                api.removeEventListener({
                    name:'viewdisappear'
                });
            }
            updateUsers();
            //跳转到新用户缴费成功立即使用页面
            var account = $api.getStorage('userPhone') ? 'tel' : '3th';
            sendMathEventUmeng(CONSTANT.UMENGEVENT.VIP_SUCCESS,{
                channel:extra.channel,
                account:account
            },parseInt(extra.amount));

            var name = 'newVip_success';
            var url = '../newVip_success.html';
//            if(account == '3th'){
//                //第三方登录缴费成功后未绑定手机号
//                name = 'bindPhone';
//                url = '../bind_new.html';
//            }
            setTimeout(function(){
                api.openWin({
                    name: name +"win",
                    url: url,
                    slidBackType:'edge',
                    delay:100,
                    softInputMode: "resize",
                    pageParam:{
                        from:{
                            winName:api.winName,
                            frameName:api.frameName
                        }
                    }
                });
            },50);
        } else {
            toastMsg(ret.msg);
        }
    }
    function checkErrorCallback(err, extra) {
        toastMsg(err.msg);
    }
    //缴费成功后更新用户缓存
    function updateUsers(){
        var url = serviceNew + 'user';
        var headers = _getAjaxHeaders(true, true);
        var data = _getAjaxData();
        _ajaxData(url, 'post', headers, data, updateUsersSuccessCallback, null, 0);
    }
    function updateUsersSuccessCallback(ret) {
        if (ret.statusCode == '200') {
            var isMember = ret.data.user.isMember;
            var vipType = '';
            if (isMember == 'monthly') {
                vipType = '月费会员';
            }else if (isMember == 'activity') {
                vipType = '活动会员';
            }else if (isMember == 'annual') {
                vipType = '年费会员';
            }
            //是否新用户
//				$api.setStorage('isNewUser', false);
            $api.setStorage('vipType', vipType); //会员类型
            $api.setStorage('isMember', isMember);//会员类型
            $api.setStorage('dueTime', ret.data.user.dueTime ? ret.data.user.dueTime : "");//会员截止时间
            $api.setStorage('count', ret.data.user.dorabag.count);//多啦袋个数
            $api.setStorage('perBag', ret.data.user.dorabag.perBag);//每个多啦袋放衣服数量
            $api.setStorage('deposit', ret.data.user.deposit || 0);//押金
            $api.setStorage('userInviteCode',ret.data.user.secfile.inviteCode || '');//用户的邀请码
        } else {
            toastMsg(ret.msg);
        }
    }
    //回到首页
    function goBackIndex(){
        var stayTime = 0;
        //是否新用户
        if(isTrue($api.getStorage('isNewUser')||'')){
            api.execScript({
                name:"root",
                script: "initRoot();"
            });
            stayTime = 100;
        }
        //刷新我的页面
        api.execScript({
            name : 'root',
            frameName : "footer_tab_4",
            script : 'init();'
        });
        //刷新我的衣橱页面
        api.execScript({
            name : 'root',
            frameName:"closet_frame",
            script: "init();"
        });
        setTimeout(function(){
            api.closeToWin({
                name: 'root'
            });
        },stayTime)
    }
    //点击关闭图标
    function closeIcon(){
        goBackIndex();
    }
</script>
</body>
</html>
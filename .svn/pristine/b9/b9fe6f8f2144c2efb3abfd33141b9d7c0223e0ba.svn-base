<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>下单</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/2_0/aui_2_0.css" />
    <link rel="stylesheet" type="text/css" href="../../css/2_0/rem.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/2_0/util.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/fonts/duola_iconfont2.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/uzui.css"/>
    <style>
        .aui-content {
            padding-bottom: 3rem;
        }
        .aui-list .aui-list-item {
            padding-bottom: 0.5rem;
            padding-top: 0.5rem;
            padding-left: 1rem;
        }
        .aui-list .aui-ellipsis-1 {
            width: 9rem;
        }
        #bag .aui-list-item-text {
            padding-top: 0.5rem;
        }
        #bag .aui-list-item:active {
            background-color: #FFFFFF;
            -webkit-transition: background-color 0.2s linear;
            transition: background-color 0.2s linear;
        }
        #bag .aui-list-item-inner {
            padding-right: 1rem;
            padding-top: 1.5rem;
        }
        #bag .aui-list-item-title {
            font-size: 0.7rem;
            color: #424242;
        }
        #bag .aui-label-black {
            background-color: #000000;
        }
        #address .aui-list-item-media .aui-list-item-title, .aui-list-item-text {
            font-size: 0.7rem;
            color: #6F6F6F;
        }
        #address .aui-list-item-title {
            font-size: 0.7rem;
            color: #1A1A1A;
        }
        #address .aui-list-item-media {
            padding-right: 0;
            width: 3rem;
        }
        #address .aui-list-item-inner .address-phone-text {
            color: #1A1A1A;
        }
        .my-foot{
            height:3rem;position: fixed; left: 0px; right: 0px; bottom: 0px;
            line-height: 3rem;
            color: #ffffff;
            z-index: 10;
            width: 100%;
            min-height: 2.25rem;
            font-size: 1rem;
            text-align: center;
            display: table;
        }
        .my-bg-cancel {
            background: #DEDEDE;
        }
        .aui-list{
            margin-bottom: -1px;
        }
        .aui-switch:checked {
            border-color: #FF3C54 ;
            background-color: #FF3C54 ;
        }
        
        
        /* 模态框  押金不足 */
		
		.modal-open{
			position:fixed;
			width:100%;
			height:100%;
			overflow:hidden;
		}
		.modal{
			position:fixed;
			z-index: 9999;
			top:0;
			left:0;
			width:100%;
			height:100%;
			background: rgba(0, 0, 0, 0.3);
		}
		.modal-content{
			position:absolute;
			left:0;
			bottom:0;
			width:100%;
			margin:auto;
			background:#F8F8F8;
		}
		.modal-head{
			position: relative;
			font-family:SourceHanSansCN-Bold;
			text-align:left;
			color:#767676;
			height:4.5rem;
			font-size:0.8rem;
			line-height:4.5rem;
			padding:0 1.5rem;
		}
		.modal-head:after{
			content:"";
			position: absolute;
			left:0;
			bottom: 0;
			width: 100%;
			height: 1px;
			background: #DDDDDD;
			transform: scaleY(0.5);
		}
		.modal-head .title{
			font-family: SourceHanSansCN-Bold;
			font-size: 1rem;
			color: #333333;
		}
		.modal-head i.close{
			position: absolute;
			top:0;
			right: 0;
			color: #979797;
			font-size: 0.6rem;
			right: 0.5rem;
			top: -0.7rem;
		}
		.modal-body{
			padding:1rem 1.5rem 1rem 1.5rem;
			height:10rem;
			overflow-y:auto;
			font-family: SourceHanSansCN-Normal;
			font-size: 0.7rem;
			color: #333333;
			line-height: 1.2rem;
		}
		.modal-body p{
			font-family: SourceHanSansCN-Normal;
			font-size: 18px;
			color: #FF3C54;
		}
		.modal-footer{
			position:relative;
			overflow:hidden;
		}
		.modal-footer:before{
			content:"";
			position: absolute;
			top:0;
			left:0;
			width: 100%;
			height: 1px;
			background: #DDDDDD;
			transform: scaleY(0.5);
		}
		.modal-footer .btn-pay{
			 position: relative;
            overflow: hidden;
            float: left;
            width: 50%;
            font-family: SourceHanSansCN-Light;
            font-size: 1rem;
            color: #333333;
            text-align: center;
            padding: 0.5rem 0;
		}
		.btn-pay:nth-of-type(1):before{
            content: "";
            position: absolute;
            top:0;
            right: 0;
            width: 1px;
            height: 100%;
            background: #dddddd;
        }
        .btn-pay:nth-of-type(2):before{
            content: "";
            position: absolute;
            top:0;
            left: 0;
            width: 1px;
            height: 100%;
            background: #dddddd;
        }
        .btn-pay i{
            display: inline-block;
            vertical-align: middle;
            font-size: 1rem;
            margin-right: 0.5rem;
            color: #1B9DFF;
        }
        .btn-pay:nth-of-type(2) i{
            color: #02D10F;
        }
		.modal button{
			width:50%;
			border:none;
			outline:none;
			height:3rem;
			float:left;
			font-family: SourceHanSansCN-Regular;
			font-size: 1rem;
		}
    </style>
</head>
<body class="">

<div class="aui-content aui-margin-b-15 ">
    <ul class="aui-list aui-media-list" id="address">
    </ul>
    <ul class="aui-list aui-list-in" >
        <li class="aui-list-item">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-title">环保邮递，告别纸箱</div>
                <div class="aui-list-item-right" >
                    <input type="checkbox" class="aui-switch" id="switch" checked>
                </div>
            </div>
        </li>
    </ul>
    <ul class="aui-list aui-media-list" id="bag">
        <!--<li class="aui-list-item">-->
        <!--<div class="aui-media-list-item-inner">-->
        <!--<div class="aui-list-item-media">-->
        <!--<img src="http://img.duolayimeng.com/original/1528833-1.jpg@!640w960h90q">-->
        <!--</div>-->
        <!--<div class="aui-list-item-inner">-->
        <!--<div class="aui-list-item-text">-->
        <!--<div class="aui-list-item-title">舒适显腿高腰裙子</div>-->
        <!--<div class="aui-list-item-right">-->
        <!--<i class="aui-iconfont aui-icon-trash"></i>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="aui-list-item-text">-->
        <!--<b>M</b>-->
        <!--</div>-->
        <!--<div class="aui-list-item-text">-->
        <!--<div class="aui-col-xs-7">-->
        <!--</div>-->
        <!--<div class="aui-col-xs-5 ">-->
        <!--<div class="aui-pull-right">-->
        <!--<span style="font-size: 0.6rem">加入哆啦袋+</span>-->
        <!--<i class="aui-iconfont aui-icon-calendar "></i>-->
        <!--</div>-->

        <!--</div>-->
        <!--</div>-->
        <!--</div>-->

        <!--</div>-->
        <!--</li>-->
        <!--<li class="aui-list-item">-->
        <!--<div class="aui-media-list-item-inner">-->
        <!--<div class="aui-list-item-media">-->
        <!--<img src="http://img.duolayimeng.com/original/1528833-1.jpg@!640w960h90q">-->
        <!--</div>-->
        <!--<div class="aui-list-item-inner">-->
        <!--<div class="aui-list-item-text">-->
        <!--<div class="aui-list-item-title" >-->
        <!--<div class="aui-ellipsis-1">-->

        <!--显腿高腰裙子舒适显腿高腰裙子舒适显腿高腰裙子 显腿高腰裙子舒适显腿高腰裙子舒适显腿高腰裙子 显腿高腰裙子舒适显腿高腰裙子舒适显腿高腰裙子 显腿高腰裙子舒适显腿高腰裙子舒适显腿高腰裙子 显腿高腰裙子舒适显腿高腰裙子舒适显腿高腰裙子-->
        <!--</div>-->

        <!--<div class="aui-list-item-text">-->
        <!--<b>M</b>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="aui-list-item-right" >-->
        <!--&lt;!&ndash;<i class="aui-iconfont aui-icon-trash"></i>&ndash;&gt;-->
        <!--<div class="aui-label aui-label-danger aui-label-black">借衣中</div>-->
        <!--</div>-->
        <!--</div>-->


        <!--</div>-->

        <!--</div>-->
        <!--</li>-->
        <!--<li class="aui-list-item">-->
        <!--<div class="aui-media-list-item-inner">-->
        <!--<div class="aui-list-item-media">-->
        <!--<img src="http://img.duolayimeng.com/original/1528833-1.jpg@!640w960h90q">-->
        <!--</div>-->
        <!--<div class="aui-list-item-inner">-->
        <!--<div class="aui-list-item-text">-->
        <!--<div class="aui-list-item-title">舒适显腿高腰裙子-->
        <!--<div class="aui-list-item-text">-->
        <!--<b>M</b>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="aui-list-item-right">-->
        <!--<i class="duola-iconfont icon-remove"></i>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</li>-->
    </ul>

</div>

<footer class=" my-foot" id="order" tapmode onclick="sendBtn(this);"></footer>

	<div class="modal hide" id="modal">
		<div class="modal-content">
			<div class="modal-head">
				<i onclick="closeModal()" class="close duola-iconfont icon-Close"></i>
				<span id="modal-title">需支付300RMB押金</span>
			</div>
			<div class="modal-body">
				芝麻信用积分>700的可免押金
				<p onclick="goSesame()">去看看 <i class="duola-iconfont icon-btn-in"></i></p>
			</div>
			<div class="modal-footer">
				<!--<button onclick="payment('alipay')">支付宝</button>
				<button onclick="payment('wx')">微信</button>-->
				<div  onclick="payment('alipay')" class="btn-pay"><i class="duola-iconfont icon-zfb-money"></i>支付宝支付</div>
            		<div onclick="payment('wx')" class="btn-pay"><i class="duola-iconfont icon-wechat-money"></i>微信支付</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/url.js"></script>
<script type="text/javascript" src="../../script/uz.js"></script>
<script type="text/javascript" src="../../script/umeng_sdk.js"></script>
<script type="text/javascript" src="../../script/doT_min.js"></script>
<script type="text/javascript" src="../../script/log_sdk.js"></script>
<script type="text/javascript" src="../../script/pingpp.js"></script>
<script id="bag-template" type="text/x-dot-template">
    {{ for(var i = 0; i < it.length; i++) { }}
    <li class="aui-list-item" id="{{='bag-id-'+i}}" title="{{=it[i].tag}}">
        <div class="aui-media-list-item-inner">
            <div class="aui-list-item-media">
                <img src="../../image/hold.jpg" tapmode class="{{=CONSTANT.CACHECLASSNAME}}" title="{{=getImgUrl2([colthPath,it[i].img,colthPathStyle])}}">
            </div>
            <div class="aui-list-item-inner">
                <div class="aui-list-item-text">
                    <div class="aui-list-item-title" >
                        <div class="aui-ellipsis-1">
                            {{=it[i].name}}
                        </div>
                        <div class="aui-list-item-text">
                            <b>{{=it[i].size.toUpperCase()=="J"?"均码":it[i].size}}</b>
                        </div>
                    </div>
                    {{? it[i].tag == "YES"}}
                    <div class="aui-list-item-right" >
                        <div class="aui-label aui-label-danger aui-label-black">借衣中</div>
                    </div>
                    {{??}}
                    <div class="aui-list-item-right" >
                        <i class="duola-iconfont icon-remove" onclick=" {{='deleteBag(\''+ ('bag-id-'+i) +'\',\''+ i +'\',\''+it[i].size+'\',\''+it[i]._id+'\',\''+it[i].online+'\',\''+it[i].barcode+'\')'}}"></i>
                    </div>
                    {{?}}
                </div>
            </div>
        </div>
    </li>
    {{ } }}
</script>

<script id="address-template" type="text/x-dot-template">
    <li class="aui-list-item" onclick="openAdd()">
        <div class="aui-media-list-item-inner">
            <div class="aui-list-item-media">
                <div class="aui-list-item-text">
                    <div class="aui-list-item-title">配送至
                        <div class="aui-list-item-text">
                            收货人
                        </div>
                    </div>
                </div>
            </div>
            <div class="aui-list-item-inner">
                <div class="aui-list-item-text">
                    <div class="aui-list-item-title aui-ellipsis-1" style="width: 12rem;" >
                        {{=it.province}}{{=it.city}}{{=it.county}}{{=it.detail}}
                        <div class="aui-list-item-text address-phone-text">
                            {{=it.name}} {{=it.phone}}
                        </div>
                    </div>
                    <div class="aui-list-item-right">
                        <!--<i class="duola-iconfont icon-modify"></i>-->
                        修改
                    </div>
                </div>
            </div>
        </div>
    </li>
</script>
<script type="text/javascript">
    var frameData = null;
    var chooseCan = 0;//多啦袋可选数量
    var hasChoose = 0;//多啦袋已选数量
    var addressList;
    var addressNum = 0;
    var  setConsume = [];
    apiready = function(){
        frameData = api.pageParam.data;
        init("reInfo");
        getDeposit2();
        openAddress();
        api.addEventListener({
            name: 'sendAddress'
        }, function(ret, err){
            openAddress()
        });
        api.parseTapmode();
        $api.addEvt($api.byId("switch"), 'click', function(){
            carton();
        });
    };

    function initSuccessCallback(ret,extra){
        _loadingHide();
        _showPage();
        if(ret.statusCode=='200'){
            var my_own = ret.dorabag.list;
            var bagOwn = my_own.filter(function(item){return item.tag == 'YES';}).length; 	 		 //用户当前持有的多啦袋数量
            chooseCan = ret.dorabag.count - bagOwn; //多啦袋可选数量
            hasChoose = my_own.length - bagOwn;//多啦袋已选数量
            setCloset(my_own);
            checkNeedClothes();

        }else if(ret.statusCode=='10104'){
            goLogin('',"../win_regin.html");
        }else{
            toastMsg(ret.msg);
        }
    }
    //检查至少还需要选多少件衣服才能下单
    function checkNeedClothes(){
        var orderEl = $api.byId('order');
        var needClothes = 0;//至少还需要选多少件衣服才能下单
        if(chooseCan <= 3){
            needClothes = chooseCan - hasChoose;
        }else{
            needClothes = 3 - hasChoose;
        }
        if(needClothes > 0 ){
            $api.removeCls(orderEl,'my-bg-color');
            $api.addCls(orderEl,'my-bg-cancel');
            $api.text(orderEl,'还差'+needClothes+'件衣服就能配送');
        }else{
            $api.removeCls(orderEl,'my-bg-cancel');
            $api.addCls(orderEl,'my-bg-color');
            $api.text(orderEl,'立即配送');
        }
    }
    function initErrorCallback(err,extra){
        _loadingHide();
        _showPage();
        toastMsg(err.msg);
    }
    function init() {
        var url = serviceNew + 'dorabag';
        var headers = _getAjaxHeaders(true,true);
        var data = _getAjaxData();
        var extra = null;
        _ajaxData(url,'post',headers,data,initSuccessCallback,initErrorCallback,0,extra);
    }

    function openAddress(){
        var url = serviceUser + 'address/list';
        var headers = _getAjaxHeaders(token,true);
        var data = _getAjaxData();
        var extra = null;
        _ajaxData(url,'post',headers,data,addressSuccessCallback,initErrorCallback,0,extra);
    }
    function addressSuccessCallback(ret,extra ) {
        if(ret.statusCode=='200' && ret.list){
            if (ret.list.length > 0) {
                addressList = ret.list;

                for (var i=0; i < addressList.length; i++) {
                    if (addressList[i].defaultAddress && addressList[i].defaultAddress === "YES") {
                        addressNum = i;
                        break;
                    }
                }
                doHtml("address","address-template",addressList[addressNum]);
            }else {
                var data = {
                    province:"暂无地址,点击新增地址",
                    city:"",
                    county:"",
                    detail:"",
                    name:"",
                    phone:""
                };
                addressList = [];
                doHtml("address","address-template",data);
            }

        }else if(ret.statusCode=='10104'){
            toLogin();
        }else{
            toastMsg(ret.msg)
        }
    }
    function openAdd() {
        api.openFrame({
            name: 'address',
            url: '../addressFoot_new.html',
            rect: {
                x:0,
                y:0,
                w: 'auto',
                h: 'auto'
            },
            pageParam: {
                addList: addressList,
                addressNum: addressNum
            }
        });
    }
    function carton() {
//      var carton = api.getPrefs({
//          sync: true,
//          key: 'carton'
//      }) || null;

//      if (!carton) {
        var dialogBox = api.require('dialogBox');
        var text = '为避免家中纸盒堆积,多啦衣梦建议您使用' +"\n"+
                '绿色极简运输方式,感谢您为环保贡献力量';
        dialogBox.sendMessage({
            texts: {
                title: '提示',
                content: text,
                leftBtnTitle:"残忍拒绝",
                rightBtnTitle: '知道了'
            },
            styles: {
                bg: '#fff',
                w: 340,
                title: {
                    h: 60,
                    show: {
                        marginL: 35,
                        titleSize: 18,
                        titleColor: '#000'
                    }
                },
                content: {
                    marginT: 0,
                    marginL:10,
                    color: '#000',
                    size: 14
                },
                left: {
                    marginB: 20,
                    marginL: 160,
                    w: 70,
                    h: 35,
                    corner: 2,
                    bg: '#FFF',
                    size: 13,
                    color: '#000'
                },
                right: {
                    marginB: 20,
                    marginL: 10,
                    w: 70,
                    h: 35,
                    corner: 2,
                    bg: '#FFF',
                    size: 16,
                    color: '#FF3C54'
                }
            }
        }, function(ret) {

            if (ret.eventType !== 'left') {

//                  api.setPrefs({
//                      key: 'carton',
//                      value: "NO"
//                  });
                var switchDom = $api.byId("switch");
                switchDom.checked = true;

            }
            dialogBox.close({
                dialogName: 'sendMessage'
            });
        });
//      }

    }
    function setCloset(bags){

        doHtml("bag","bag-template",bags);
        var themeGroupContainer = $api.byId('bag');
        _imgCacheUrl3(themeGroupContainer);
        bags.forEach(function(bag){
            if (bag.tag === "NO") {
                setConsume.push({item_id: bag._id,bhv_amt: parseFloat(bag.price),bhv_cnt: 1});
            }
        });
    }

    //公用头部导航栏坐侧点击异步执行的方法
    function execNavLeftCallback(value){
        var from = frameData.from;
        var callback = frameData.leftNavCallback ? frameData.leftNavCallback : '';
        if(!isDefine(callback)){
            return;
        }
        var extra = frameData.leftNavExtra ? frameData.leftNavExtra : '';
        var params = {
            script: getExecScript(callback,new Array(extra,api.winName,value))
        };
        if(isDefine(from.winName)){
            params.name = from.winName;
        }
        if(isDefine(from.frameName)){
            params.frameName = from.frameName;
        }
        api.execScript(params);
    }

    //公用头部导航栏右侧点击异步执行的方法
    function execNavRightCallback(value){
        var from = frameData.from;
        var callback = frameData.rightNavCallback ? frameData.rightNavCallback : '';
        if(!isDefine(callback)){
            return;
        }
        var extra = frameData.rightNavExtra ? frameData.rightNavExtra : '';
        var params = {
            script: getExecScript(callback,new Array(extra,api.winName,value))
        };
        if(isDefine(from.winName)){
            params.name = from.winName;
        }
        if(isDefine(from.frameName)){
            params.frameName = from.frameName;
        }
        api.execScript(params);
    }
    //更新立即配送按钮
    function foot () {
        var orderEls = $api.domAll($api.byId('bag'),'li[title="NO"]');
        hasChoose = orderEls.length;
        checkNeedClothes();
    }
    function deleteBag (domId,n,size,id,online,barcode) {
        if(online=='YES'){
            var body = {
                "cloth":{
                    "_id": id,
                    "size": size,
                    "tag": n // 原样返回的tag, 可选
                }
            }
        }else{
            var body = {
                "cloth":{
                    barcode:[String(barcode)]
                }

            }
        }
        var url = serviceNew + 'dorabag/uncheck';
        var headers = _getAjaxHeaders(true,true);
        var data = _getAjaxData(body);
        var extra = {domId: domId,'_id': id,"size" : size};
        _ajaxData(url,'post',headers,data,uncheckSuccessCallback,uncheckErrorCallback,0,extra);
    }
    function closeMask(){
        api.closeFrame({
            name: 'address'
        });
    }
    function getChoose(num) {
        addressNum = num;
        doHtml("address","address-template",addressList[num]);
        closeMask();
    }
    function uncheckSuccessCallback(ret, extra){
        _loadingHide();
        if(ret.statusCode=="200"){
            $api.remove( $api.byId(extra.domId));
            foot();
            api.execScript({
                name : 'root',
                frameName : "footer_tab_3",
                script : "removeBag('"+extra._id+"','"+extra.size+"');"
            });
            api.sendEvent({
                name: 'reloadCloset'
            });
            toastMsg("移除成功");
        }else if(ret.statusCode=='10104'){
            toLogin();
        }else{
            toastMsg(ret.msg);
        }
    }
    function uncheckErrorCallback(err,extra){
        _loadingHide();
        toastMsg(err.msg);
    }
    function sendBtn(el){
        if($api.text(el) !== '立即配送'){
            return;
        }
        if (!addressList || addressList.length == 0 ) {
            toastMsg("您未选择地址，请重试。");
            return;
        }
        sendMathEventUmeng(CONSTANT.UMENGEVENT.ORDER_CLOTH,{address:addressNum},1);
        var bodyT = {"address":Number(addressNum)
        };
        var isSwitch = $api.byId('switch');
        if (!isSwitch.checked) {
            bodyT.attachment = "纸箱"
        }
        _loadingShow();
        var url = serviceNew + 'dorabag/delivery';
        var headers = _getAjaxHeaders(true,true);
        var data = _getAjaxData(bodyT);
        var extra = null;
        _ajaxData(url,'post',headers,data,sendBtnSuccessCallback,sendBtnErrorCallback,0,extra);
    }
    function sendBtnSuccessCallback(ret,extra) {
        _loadingHide();
        if(ret.statusCode=='200'){
            api.sendEvent({
                name: 'reloadCloset',
            });
            api.execScript({
                name : 'root',
                frameName : "closet_frame",
                script : "bagStatus('YES');"
            });

            setLogConsumeWrap(setConsume);
            api.openWin({
                name: 'orderSuccess',
                url: '../winOrder.html',
                pageParam:{
                    name: 'orderSuccess',
                    page: 'orderOk',
                    title: '配送成功'
                }
            });
        }else if(ret.statusCode=="20106"){
        		openModal();  // 打开模态框
        }else{
            toastMsg(ret.msg)
        }
    }
    function sendBtnErrorCallback(err,extra){
        toastMsg(err.msg);
        _loadingHide();
    }
    
    function goSesame(){  // 跳转到芝麻认证页面
    		api.openWin({
	            name: 'sesame_header',
	            url: '../sesame/sesame_header.html',
	            pageParam:{
	            		from:{
	            			winName: api.winName,
	            			frameName: api.frameName
	            		}
	            }
            });
    }
    
    function openModal(){  // 打开模态框
    		document.getElementById("modal").classList.remove("hide");
    		document.body.classList.add("modal-open");
    }
    
    function closeModal(){   // 关闭模态框
    		document.getElementById("modal").classList.add("hide");
    		document.body.classList.remove("modal-open");
    }
    
    function execCloseModal(){  // 异步关闭模态框
    		closeModal();
    }
    
    function payment(type){  // 支付
    		api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '正在支付···',
            text: '请稍候'
        });
    		getDeposit(type);
    }
    
    function getDeposit(type){  // 获取押金的相关信息
    		var url = serviceUser + "service/pay/query/payDeposit",
    				headers = _getAjaxHeaders(true, false),
    				data = _getAjaxData();
    			
    		_ajaxData(url, "post", headers, data, function(ret){
    			if(ret.statusCode==200){
    				paymentDeposit(type,ret);
    			}else{
    				_loadingHide();
    				toastMsg(ret.msg);
    			}
    		}, function(err){
    			_loadingHide();
    			toastMsg(err.msg);
    		})
    }
    
    function getDeposit2(){  // 获取显示需要的数据，暂时这样写，有时间了再和getDeposit合并
    		var url = serviceUser + "service/pay/query/payDeposit",
    				headers = _getAjaxHeaders(true, false),
    				data = _getAjaxData();
    			
    		_ajaxData(url, "post", headers, data, function(ret){
    			if(ret.statusCode==200){
    				document.getElementById("modal-title").innerHTML = "需支付"+ ret.deposit +"RMB押金";
    			}else{
    				toastMsg(ret.msg);
    			}
    		}, function(err){
    			toastMsg(err.msg);
    		})
    }
    
    function paymentDeposit(type, param){  // 支付押金
    		var url = serviceUser + 'service/pay/start/payDeposit',
    				headers = _getAjaxHeaders(true, false),
    				data = _getAjaxData({
    					bags: 1,
                    channel: type,
                    amountFront: param.deposit,
                    coupons: param.coupons,
                    duration: 1
    				});
    		
    		_ajaxData(url, 'post', headers, data, function (ret, extra) {
        		if (ret.statusCode == '200') {
                    ping(ret.charge,'userSesameDeposit');
               } else if (ret.statusCode == '10104') {
               		_loadingHide();
    					toastMsg(ret.msg);
                    goLogin('',"../win_regin.html");
                } else {
                    _loadingHide();
    					toastMsg(ret.msg);
                }
            }, function (err, extra) {
            		_loadingHide();
                toastMsg(err.msg);
            });
    }
    
    //    支付完成后调用check_pay接口验证
    function check() {
        var url = serviceUser + 'service/check/payment';
        var headers = _getAjaxHeaders(true, true);
        var data = _getAjaxData();
        var extra = null;
        _ajaxData(url, 'post', headers, data, checkSuccessCallback, checkErrorCallback, 0, extra);
    }
    function checkSuccessCallback(ret, extra) {
        if (ret.statusCode == '200') {
			execCloseModal();
			_loadingHide();
        } else {
        		_loadingHide();
            toastMsg(ret.msg);
        }
    }
    function checkErrorCallback(err, extra) {
    		_loadingHide();
        toastMsg(err.msg);
    }
</script>
</html>